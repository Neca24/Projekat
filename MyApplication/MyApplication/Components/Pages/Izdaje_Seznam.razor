@page "/Izdaje-seznam"

@using DataAccessLayer.Models;
@using System.Linq.Expressions
@using BusinessLayer.Services.StateServices
@using BusinessLayer.Interfaces

@inject ISnackbar _sb
@inject UserState _userState
@inject IIzdajeService _izdajeService
@inject NavigationManager NavManager
@inject SaveUrlService _returnUrl

<pre>
@* View Izdaje seynam
Main function:
1.	Table (Mudblazor Dbgrid/table) showing results from SQL statement.
SQL statement is variable
o	can show more columns (defined in statement)
o	can have none/single/more rows – depends on result of SQL statement
2.	Button »Filter« to change (C# code) SQL statement and refresh view of table
3.	Button »Select« to select current row and do some C# code like
o	do some C# checking current row variables (like verify that some fields have correct value – simple check)
o	do some C# (calling function »VerifyContentSelectedIzdaje« with some parameters (several fields from selected row)
o	if result ok:
o	- C# to open other view/page:
	write current Izdaje.Id in variable ThisIzdajeSelectionID
	open “Home” view(page)
o	C# show message(popup?)
4.	Button “Modify”
Similar function as “Select” but different checking (and calling function) and opening different view(page) – “IzdajeEdit”
5.	Button “Addy”
Similar function as “Modify” but different checking (and calling function) and opening different view(page) – “IzdajeAdd”

On startup:
-	C# to set proper SQL statement ()
-	Based on result number of columns:
o	0 - Disable button “Modify”, “Select”
o	>0 – Enable button “Modify”, “Select” *@


</pre>

<div class="main">

    <div class="header" Style="height: var(--header-height);padding:0;">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-4" Style="height: var(--header-height)">
            <MudText Typo="Typo.h5">Transkacije - Seznam </MudText>
        </MudStack>
    </div>

    <MudStack Row="true" Spacing="2" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mb-4" Style="height: var(--header-height)">
        <MudButton Style="width:25%" FullWidth="true" Color="Color.Tertiary" Variant="Variant.Filled" OnClick="Default">Default</MudButton>
        <MudButton Style="width:25%" FullWidth="true" Color="Color.Tertiary" Variant="Variant.Filled" OnClick="Custom">Custom</MudButton>
    </MudStack>

    @*TODO-start*@
    <div class="grid" Style="height: var(--grid-height);padding-bottom:0;padding:0;">
        <MudDataGrid Dense="true" Bordered="true" Virtualize="true" T="Izdaje" Items="@izdajeList"
            RowClick="RowClicked" 
            RowStyleFunc="@rowStyleFunc"
            Height="calc(var(--grid-height2))"
            Style="height:calc(var(--grid-height2))"
            FixedHeader="true"
            Breakpoint="Breakpoint.Xs"
            Hover="true"
            QuickFilter="quickFilter">
            <ToolBarContent>
                <MudSpacer />
                <MudSpacer />
                <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" 
                    Immediate="true"
                    AdornmentIcon="@Icons.Material.Filled.Search" 
                    IconSize="Size.Medium" Class="mt-0"/>
            </ToolBarContent>
            <Columns>
                @foreach(var col in columns)
                {
                    <PropertyColumn Property="@(col.Property)" Title="@(col.Title)"/>
                }
            </Columns>
            <NoRecordsContent>
                <MudAlert Variant="Variant.Outlined" Severity="Severity.Error">Nema podataka za prikaz</MudAlert>
            </NoRecordsContent>
        </MudDataGrid>
    </div>
    @*TODO-end*@

    <div class="footer" Style="height: var(--footer-height); padding:0; padding-top:var(--tablenav-height)">
        <MudStack Row Spacing="2" Justify="Justify.Center" Class="mt-4">
            <MudButton FullWidth="true" Color="Color.Primary" Variant="Variant.Filled" OnClick="AddNewIzdaje">Add new</MudButton>
            <MudButton FullWidth="true" Color="Color.Warning" Variant="Variant.Filled" Disabled="@(!isSelectedIzdaje)" OnClick="EditIzdaje">Edit</MudButton>
            <MudButton FullWidth="true" Color="Color.Success" Variant="Variant.Filled" Disabled="@(!isSelectedIzdaje || _returnUrl.RootUrl==null)" OnClick="SelectIzdaje">Select</MudButton>
        </MudStack>

    </div>

</div>




<style>

    .main {
        @* adjust header, footer height*@
        --header-height: 50px;
        --footer-height: 50px;
        @* vertical pading from somewhere *@
        --padding-height: 5px;
        @* height for table navigation below rows *@
        --tablenav-height: 35px;
        @* height for main section *@
        --mainview-height: calc( 100vh - var(--mud-appbar-height) - var(--padding-height) );
        @*background-color: grey;
        padding-inline: 0px; *@
        height: var(--mainview-height);
        display: flex;
        flex-direction: column;
        justify-content: normal;
        @* calc height grid *@
        --grid-height_temp: calc(var(--header-height) + var(--footer-height) + var(--tablenav-height));
        --grid-height: calc(var(--mainview-height) - var(--grid-height_temp) );
        @* calc height table need be smaller because of navigation bar *@
        --grid-height2: calc(var(--mainview-height) - var(--grid-height_temp) );
        --footer-Top: calc(var(--mainview-height) - var(--grid-height));
    }

    .grid {
        @*background-color: orange;
        padding-inline: 10px; *@
        height: calc(var(--grid-height));
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .header {
        @* background-color: blue;
        height: calc(var(--header-height)); *@
        display: flex;
        flex-direction: column;
        justify-content: normal;
    }

    .footer {
        @* background-color: red;
        padding-inline: 10px; *@
        height: var(--footer-height);
        display: flex;
        flex-direction: column;
        justify-content: normal;
    }

</style>

@code {
    private List<Izdaje>? izdajeList = new();
    private Izdaje? selectedRow;
    private int filter = 0;//DEFAULT
    private bool isSelectedIzdaje => selectedRow is not null;
    private string? searchString;
    private List<(Expression<Func<Izdaje, object>> Property, string Title)> columns = new();

    private async Task LoadData()
    {
        izdajeList = await _izdajeService.GetAllQueryIzdaje(filter);
    }

    private void GenerateColumns()
    {
        if (_userState.CurrentUserRights == 1)
        {
            columns = new()
            {
                (i=>i.Id,"ID"),
                (i=>i.Status!,"Status"),
                (i=>i.Sinhronizirano,"Sinhronizirano"),
                (i=>i.IdPis,"ID_PIS"),
                (i=>i.TocilniNalog,"Točilni nalog"),
                (i=>i.OdpremniNalog,"Odpremni nalog"),
                (i=>i.Skladisce,"Skladišce"),
                (i=>i.Lastnik,"Lastnik"),
                (i=>i.NacinOdpreme,"Način odpreme"),
                (i=>i.TipPrevoznegaSredstva,"Tip prevoznega sredstva"),
                (i=>i.DatumOdpreme,"Datum odpreme"),
                (i=>i.Vozniki.Opis,"Voznik"),
                (i=>i.Vozila.Opis,"Vozilo"),
                (i=>i.Relacija,"Relacija"),
                (i=>i.VrstaPlina,"Vrsta plina"),
                (i=>i.PredvidenaKolicina,"Predvidena količina"),
                (i=>i.DokumentDobavnice,"Dokument dobavnice"),
                (i=>i.DatumOdpremeKonec,"Datum odpreme konec"),
                (i=>i.DejanskaKolicina,"Dejanska količina"),
                (i=>i.Operater,"Operater"),
                (i=>i.Veljavnost,"Veljavnost"),
                (i=>i.VpisUporabnik,"Vpis uporabnik"),
                (i=>i.VpisDatetime,"Vpis datetime"),
                (i=>i.SprUporabnik,"Spr uporabnik"),
                (i=>i.SprDatetime,"Spr datetime"),
                (i=>i.TocilnaPot,"Točilna pot"),
                (i=>i.TocilnoMesto,"Točilno mesto"),
                (i=>i.ScadaVnos,"SCADA vnos"),
                (i=>i.Prikaz,"Prikaz"),
                (i=>i.MmStevilka,"Mm stevilka"),
                (i=>i.MmTemp,"Mm temp"),
                (i=>i.MmSn,"Mm sn"),
                (i=>i.MmZacetek,"Mm začetek"),
                (i=>i.MmKonec,"Mm konec"),
                (i=>i.MmRazlika,"Mm razlika"),
                (i=>i.MmKonstanta,"Mm konstanta"),
                (i=>i.RazlogPrekinitve,"Razlog prekinitve"),
                (i=>i.VrstaCisterne,"Vrsta cisterne")
            };
        }
        else if (_userState.CurrentUserRights == 2)
        {
            columns = new()
            {
                (i => i.Id, "ID"),
                (i => i.Status!, "Status"),
                (i => i.Vozniki.Opis, "Voznik"),
                (i => i.Vozila.Opis, "Vozilo")
            };
        }
        else
        {
            _sb.Add("NEMATE PRISTUP!", Severity.Error);
        }
    }

    private Func<Izdaje, bool> quickFilter => x =>
    {
        if (string.IsNullOrEmpty(searchString))
            return true;

        if (x.Vozniki!.Opis!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Vozila!.Opis!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        GenerateColumns();
    }

    private Func<Izdaje, int,string> rowStyleFunc => (item,index) =>
    {
        if(isSelectedIzdaje && item.Id == selectedRow!.Id)
        {
            return "background-color:#7e6fff; color:white;";
        }

        return string.Empty;
    };

    private void RowClicked(DataGridRowClickEventArgs<Izdaje> args)
    {
        selectedRow = args.Item;
        StateHasChanged();
    }

    private void AddNewIzdaje()
    {
        NavManager.NavigateTo("Izdaje-edit/0");
    }

    private void EditIzdaje()
    {
        if(isSelectedIzdaje && selectedRow!.Id > 0)
        {
            NavManager.NavigateTo($"Izdaje-edit/{selectedRow.Id}");
        }
    }

    private void SelectIzdaje()
    {
        if(isSelectedIzdaje && selectedRow!.Id > 0)
        {
            _returnUrl.SelectedId = selectedRow.Id;
            NavManager.NavigateTo(_returnUrl.RootUrl!);
            _returnUrl.RootUrl = null;
        }
    }

    //STATUS (1,2,5,6) & VPIS_DATETIME DESC
    private async Task Default()
    {
        filter = 0;
        await LoadData();
    }

    //STATUS ALL & VPIS_DATETIME DESC
    private async Task Custom()
    {
        filter = 1;
        await LoadData();
    }

}
