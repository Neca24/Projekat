@page "/sifranti/vozniki-edit/{VoznikiId:int}"

@using BusinessLayer.Services.StateServices
@using DataAccessLayer.Models
@using BusinessLayer.Interfaces

@inject ISnackbar _sb;
@inject IVoznikiService _voznikiService;
@inject NavigationManager NavManager
@inject UserState userState

<MudPaper Class="pa-4" Elevation="3">
    @if(userState.CurrentUserRights>0)
    {
        <MudText Typo="Typo.h5">@Title</MudText>

        <MudForm @ref="form" Model="voznikiModel">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudNumericField T="int?" @bind-Value="voznikiModel.Voznik" Label="Voznik" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="voznikiModel.Opis" Label="Opis" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField T="int?" @bind-Value="voznikiModel.VpisUporabnik" Label="Vpis uporabnik" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="selectedDate_Vpis" DateFormat="dd.MM.yyyy" Label="Vpis date" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTimePicker @bind-Time="selectedTime_Vpis" Label="Vpis time" AmPm="false" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField T="int?" @bind-Value="voznikiModel.SprUporabnik" Label="SRP uporabnik" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="selectedDate_SPR" DateFormat="dd.MM.yyyy" Label="SPR date" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTimePicker @bind-Time="selectedTime_SPR" Label="SPR time" AmPm="false" Required="true" />
                </MudItem>
            </MudGrid>

            <MudStack Breakpoint="Breakpoint.Xs" Justify="Justify.FlexEnd" Row Spacing="2" Class="mt-4">
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OkClicked">OK</MudButton>
                <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="CancelClicked">Cancel</MudButton>
            </MudStack>
        </MudForm>
    }
    else
    {
        <MudText>Access denied</MudText>
    }
</MudPaper>


@code{
    [Parameter] public int? VoznikiId { get; set; }

    private DateTime? selectedDate_Vpis = DateTime.Now;
    private TimeSpan? selectedTime_Vpis = DateTime.Now.TimeOfDay;

    private DateTime? selectedDate_SPR = DateTime.Now;
    private TimeSpan? selectedTime_SPR = DateTime.Now.TimeOfDay;

    private MudForm? form;
    private Vozniki voznikiModel = new();

    private string? Title => VoznikiId.HasValue && VoznikiId.Value > 0 ? "Edit Vozniki" : "Add new Vozniki";

    protected override async Task OnInitializedAsync()
    {
        if (VoznikiId.HasValue && VoznikiId.Value > 0)
        {
            try
            {
                var vozniki = await _voznikiService.GetVoznikiById(VoznikiId.Value);
                if(vozniki == null)
                {
                    _sb.Add("Vozniki doesnt exist");
                    return;
                }

                voznikiModel = vozniki;

                selectedDate_Vpis = vozniki.VpisDatetime!.Value.Date;
                selectedTime_Vpis = vozniki.VpisDatetime.Value.TimeOfDay;
            }
            catch (Exception e)
            {
                _sb.Add($"Error loading vozniki: {e.Message}", Severity.Error);
                return;
            }
        }
        else
        {
            voznikiModel.VpisDatetime = DateTime.Now;
            voznikiModel.SprDatetime = DateTime.Now;
        }
    }

    private async Task OkClicked()
    {
        voznikiModel.VpisDatetime = selectedDate_Vpis + selectedTime_Vpis;
        voznikiModel.SprDatetime = selectedDate_SPR + selectedTime_SPR;

        await form!.Validate();
        if (!form.IsValid)
        {
            _sb.Add("Check the entered data",Severity.Error);
            return;
        }
        try
        {
            if(VoznikiId.HasValue && VoznikiId.Value > 0)
            {
                var res = await _voznikiService.UpdateVozniki(voznikiModel);
                if (res.Success)
                {
                    _sb.Add(res.Message, Severity.Success);
                    NavManager.NavigateTo("/sifranti/vozniki-seznam");
                }
                else
                {
                    _sb.Add(res.Message, Severity.Error);
                    return;
                }
            }
            else
            {
                var res = await _voznikiService.AddNewVozniki(voznikiModel);
                if (res.Success)
                {
                    _sb.Add(res.Message,Severity.Success);
                    NavManager.NavigateTo("/sifranti/vozniki-seznam");
                }
                else
                {
                    _sb.Add(res.Message, Severity.Error);
                    return;
                }
            }
        }
        catch(Exception e)
        {
            _sb.Add($"Error saving vozniki: {e.Message}", Severity.Error);
            return;
        }
    }

    private void CancelClicked()
    {
        NavManager.NavigateTo("/sifranti/vozniki-seznam");
    }
}