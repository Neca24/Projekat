@page "/"

@using BusinessLayer.Interfaces
@using BusinessLayer.Services
@using BusinessLayer.Services.StateServices
@using DataAccessLayer.Models
@using Microsoft.AspNetCore.WebUtilities

@inject SaveUrlService _returnUrl
@inject IHttpContextAccessor _http;
@inject ProtectedSessionStorage _sessionStorage;
@inject NavigationManager NavigationManager
@inject ISnackbar _sb

<pre>
@* Home screen

Show
- current user IP

Startup:
-	On startup/opening do checking 

If result:
o	Ok
Fill components (text box, numeric field) on form based on value of result SQL
o	Not ok
Empty components *@
</pre>

<MudGrid>
    <MudItem xs="12" sm="2">
        <MudTextField Variant="Variant.Outlined" Label="IP Address" ReadOnly="true" T="string" @bind-Value="ip" />
        <MudTextField @bind-Value="_selectedId" ReadOnly="true" T="int?" Label="SelectedVoziloId" Variant="Variant.Text" />
    </MudItem>
</MudGrid>

<MudButton Class="mt-6" Color="Color.Secondary" OnClick="NavigateToPage">
    Go to Other Page
</MudButton>


@code {
    private int? _selectedId;
    private string? ip;


    private void NavigateToPage()
    {
        _returnUrl.Url = NavigationManager.Uri;
        _returnUrl.TargetPage = "Vozilo";
        NavigationManager.NavigateTo("/sifranti/Vozila-Seznam");
    }

    protected override void OnInitialized()
    {
        var context = _http.HttpContext;
        ip = context!.Connection.RemoteIpAddress!.ToString();

        if (context?.Request.Headers.ContainsKey("X-Forwarded-For") ?? false)
        {
            ip = context.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        }

        if (_returnUrl.TargetPage == "Vozilo")
        {
            _selectedId = _returnUrl.SelectedId;
        }
    }
}