@page "/Izdaje-edit/{IzdajeId:int}"


@using BusinessLayer.Interfaces
@using BusinessLayer.Services
@using BusinessLayer.Services.StateServices
@using DataAccessLayer.Models

<pre>
@* View “IzdajeEdit” (form/page)
To edit existing Izdaje
Main function:
-	Based on ThisIzdajeSelectionID show values(can be modified) from row of table “izdaje”
-	Using component MudBlazer text box, numeric field
-	Some checking of entered value in fields:
o	Text field – simple value validation
o	Numeric field – simple value validation
o	Select field (Combobox) – filling from other table-šifrant( for example Izdaje.Vozilo you fill data from table Vozilo.Opis). Take care to write in izdaje valid number from Vozila.id
If value not exist then should be button to add value in šifrant(open new form, select existing or add new item, return to form, refresh combobox) 

-	Button “Potrdi” to do:
o	C# Verification of entered fields
o	If verification ok:
	write one SQL statement
	return to view “Trenutni”
o	If verification fail:
	show message with what is wrong
-	Button “Cancel” to do:
o	return to view “Trenutni”


Startup:
-	On startup/opening do checking 
o	value of variable: ThisIzdajeSelectionID like
o	Exist in SQL
o	Checking some fields to have correct range of values (can be calling function like »VerifyContentSelectedIzdaje«)
If result:
o	Ok
Fill components (text box, numeric field) on form based on value of result SQL
o	Not ok
Empty components *@



</pre>



@inject IIzdajeService _izdajeService;
@inject ISnackbar _sb;
@inject IVoznikiService _voznikiService;
@inject IVozilaService _vozilaService;
@inject NavigationManager NavManager;
@inject SaveUrlService _returnUrl;
@inject ProtectedSessionStorage protectedSessionStorage
@inject UserState _userState

<MudPaper Class="pa-4" Elevation="3">
    @if (_userState.CurrentUserRights > 0)
    {
        <MudText Typo="Typo.h5">@Title</MudText>

        <MudForm @ref="form" Model="izdajeModel">
            <MudGrid Spacing="2">

                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="izdajeModel.Voznik" T="int?" Label="Voznik" Placeholder="Select voznik"
                               Required="true" Validation="@(()=>izdajeModel.Voznik)">
                        @if (voznikiList != null)
                        {
                            @foreach (var v in voznikiList)
                            {
                                <MudSelectItem T="int?" Value="v.Id">@v.Opis</MudSelectItem>
                            }
                        }
                    </MudSelect>
                    <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" OnClick="AddNewVozniki"
                               Style="margin-top:4px;">New voznik</MudButton>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="izdajeModel.Vozilo" T="int?" Label="Vozilo" Placeholder="Select vozilo" Required="true"
                               Validation="@(()=>izdajeModel.Vozilo)">
                        @if (vozilaList != null)
                        {
                            @foreach (var v in vozilaList)
                            {
                                <MudSelectItem T="int?" Value="v.Id">@v.Opis</MudSelectItem>
                            }
                        }
                    </MudSelect>
                    <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Text" OnClick="AddNewVozilo"
                               Style="margin-top:4px;">New vozilo</MudButton>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="izdajeModel.PredvidenaKolicina" Label="Predvidena kolicina" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField Variant="Variant.Text" @bind-Value="izdajeModel.Relacija" Label="Relacija" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="izdajeModel.DokumentDobavnice" Label="Dokument dobavnice" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker DateFormat="dd.MM.yyyy" @bind-Date="_selectedDate" Label="Vpis datelj" Required="true" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTimePicker AmPm="false" @bind-Time="_selectedTime" Label="Vpis čas" Required="true" />
                </MudItem>

            </MudGrid>

            <MudStack Justify="Justify.FlexEnd" Row Spacing="2" Class="mt-4">
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OkClicked">OK</MudButton>
                <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="CancelClicked">Cancel</MudButton>
            </MudStack>
        </MudForm>
    }
    else
    {
        <MudText>Access denied</MudText>
    }
</MudPaper>


@code {
    [Parameter] public int? IzdajeId { get; set; }

    private List<Vozila> vozilaList = new();
    private List<Vozniki> voznikiList = new();
    private Izdaje izdajeModel = new();
    private MudForm? form;
    private int? _selectedVoznik;
    private int? _selectedVozilo;
    private DateTime? _selectedDate = DateTime.Now;
    private TimeSpan? _selectedTime = DateTime.Now.TimeOfDay;

    private string Title => (IzdajeId.HasValue && IzdajeId.Value > 0) ? "Edit izdaje" : "Add new Izdaje";

    private async Task LoadData()
    {
        vozilaList = (await _vozilaService.GetAllVozila()).ToList();
        voznikiList = (await _voznikiService.GetAllVozniki()).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        if (IzdajeId.HasValue && IzdajeId.Value > 0)
        {
            try
            {
                var izdaje = await _izdajeService.GetIzdajeById(IzdajeId.Value);
                if (izdaje == null)
                {
                    _sb.Add("Izdaje doesn't exist", Severity.Error);
                    return;
                }
                else
                {
                    if (_returnUrl.SelectedId.HasValue)
                    {
                        if (_returnUrl.TargetPage == "Vozilo")
                        {
                            izdaje.Vozilo = _returnUrl.SelectedId;
                        }
                        else if (_returnUrl.TargetPage == "Voznik")
                        {
                            izdaje.Voznik = _returnUrl.SelectedId;
                        }
                    }
                    _selectedDate = izdaje.VpisDatetime!.Value.Date;
                    _selectedTime = izdaje.VpisDatetime.Value.TimeOfDay;
                    izdajeModel = izdaje;
                }
            }
            catch (Exception e)
            {
                _sb.Add(e.Message, Severity.Error);
                return;
            }
        }
        else
        {
            var stored = await protectedSessionStorage.GetAsync<Izdaje>("izdajeModel");
            if (stored.Success && stored.Value != null)
            {
                izdajeModel = stored.Value;
            }
            else
            {
                izdajeModel = new Izdaje
                {
                    VpisDatetime = DateTime.Now
                };
            }

            if (_returnUrl.SelectedId.HasValue)
            {
                if (_returnUrl.TargetPage == "Vozilo")
                    izdajeModel.Vozilo = _returnUrl.SelectedId;
                else if (_returnUrl.TargetPage == "Voznik")
                    izdajeModel.Voznik = _returnUrl.SelectedId;

                _returnUrl.SelectedId = null;
                _returnUrl.TargetPage = null;
            }

            await protectedSessionStorage.DeleteAsync("izdajeModel");
        }
        StateHasChanged();
    }

    private async Task OkClicked()
    {
        izdajeModel.VpisDatetime = _selectedDate + _selectedTime;
        await form!.Validate();
        if (!form.IsValid)
        {
            _sb.Add("Check form fields", Severity.Error);
            return;
        }
        else
        {

            if (IzdajeId.HasValue && IzdajeId.Value > 0)
            {
                var res = await _izdajeService.UpdateIzdajeAsync(izdajeModel);
                if (res.Success)
                {
                    _sb.Add(res.Message, Severity.Success);
                    NavManager.NavigateTo("/Izdaje-Seznam");
                }
                else
                {
                    _sb.Add(res.Message, Severity.Error);
                    return;
                }
            }
            else
            {
                var res = await _izdajeService.AddNewIzdajeAsync(izdajeModel);
                if (res.Success)
                {
                    _sb.Add(res.Message, Severity.Success);
                    NavManager.NavigateTo("/Izdaje-Seznam");
                }
                else
                {
                    _sb.Add(res.Message, Severity.Error);
                    return;
                }
            }
        }
        await protectedSessionStorage.DeleteAsync("izdajeModel");
    }

    private void CancelClicked()
    {
        _returnUrl.SelectedId = null;
        _returnUrl.TargetPage = null;
        _returnUrl.Url = null;
        NavManager.NavigateTo("/Izdaje-Seznam");
    }

    private async Task AddNewVozilo()
    {
        await protectedSessionStorage.SetAsync("izdajeModel", izdajeModel);
        _returnUrl.TargetPage = "Vozilo";
        _returnUrl.Url = NavManager.Uri;
        NavManager.NavigateTo("/sifranti/vozila-seznam");
    }

    private async Task AddNewVozniki()
    {
        await protectedSessionStorage.SetAsync("izdajeModel", izdajeModel);
        _returnUrl.TargetPage = "Voznik";
        _returnUrl.Url = NavManager.Uri;
        NavManager.NavigateTo("/sifranti/vozniki-seznam");
    }
}